function setBonusOrder(){let e=new Object;e.token2=token2,$.ajax({type:"POST",url:"/order/set-bonus",data:e}).done(function(e){numberAnimation("#details-bonus__amount",e),updateOrder()})}function setDeliveryCalculation(){let e=$("#user__address").val();if(vSuggestion&&e){vSuggestion.value.split(",").length>2?(resetDelivery(),$("#delivery-mail__calculation").prop("disabled",!0),$('[name="delivery-variant__radio"]').prop("checked",!1),$(".details-delivery__service>span").html("транспортной компанией"),$(".details-delivery__address").addClass("d-none"),$(".details-delivery__price").addClass("d-none"),$(".details-delivery__days").addClass("d-none"),calculationDelivery()):$("#user__address").addClass("is-invalid")}else $("#user__address").addClass("is-invalid")}function setDeliveryCourier(){let e=$('input[name="delivery-courier__radio"]:checked').val();$(".details-delivery__address").removeClass("d-none"),$(".details-delivery__address>span").html(e),$(".details-delivery__service>span").html("курьером"),updateOrder()}function setDeliveryType(){resetDelivery();let e=$('input[name="delivery-type__radio"]:checked').val();if("courier"==e){$("#delivery-courier__sochi").attr("checked",!0),$(".delivery-variant").addClass("d-none"),$(".delivery-mail").addClass("d-none"),$(".delivery-courier").removeClass("d-none");let e=$('input[name="delivery-courier__radio"]:checked').val();$(".details-delivery__variant").addClass("d-none"),$(".details-delivery__service>span").html("курьером"),$(".details-delivery__address").removeClass("d-none"),$(".details-delivery__address>span").html(e),$(".details-delivery__price").removeClass("d-none"),$(".details-delivery__days").addClass("d-none"),$(".detail-delivery__service_mail").addClass("d-none"),$(".detail-delivery__service_courier").removeClass("d-none")}else"mail"==e&&($("#user__address").val(""),$(".delivery-courier").addClass("d-none"),$(".delivery-mail").removeClass("d-none"),$(".details-delivery__service>span").html("по России"),$(".details-delivery__address").addClass("d-none"),$(".details-delivery__price").addClass("d-none"),$(".details-delivery__days").addClass("d-none"),$(".detail-delivery__service_courier").addClass("d-none"),$(".detail-delivery__service_mail").removeClass("d-none"));updateOrder()}function setPaymentMethod(){1==$('input[name="payment-method__radio"]:checked').val()?(paymentText="на сайте",$(".details-payment__online").removeClass("d-none")):(paymentText="при получении",$(".details-payment__online").addClass("d-none")),$(".details-payment__method>span").html(paymentText),updateOrder()}function setDeliveryVariant(){let e=$("#user__address").val(),a=$('input[name="delivery-variant__radio"]:checked'),d=a.val(),i=a.attr("data-price"),s=a.attr("data-days");d="pvz"==d?"до пункта выдачи заказа":"курьером до двери",$(".details-delivery__variant>span").html(d),$(".details-delivery__price>span").html(i),$(".details-delivery__days>span").html(s),$(".details-delivery__address>span").html(e),$(".details-delivery__variant").removeClass("d-none"),$(".details-delivery__price").removeClass("d-none"),$(".details-delivery__days").removeClass("d-none"),$(".details-delivery__address").removeClass("d-none"),0==s&&$(".details-delivery__days").addClass("d-none"),updateOrder()}function checkoutOrder(){$(".is-invalid").removeClass("is-invalid");let e=$("#order__checkout");e.prop("disabled",!0);let a=new Object;a.token2=token2,a.address=$(".details-delivery__address>span").html(),a.delivery_type=$('input[name="delivery-type__radio"]:checked').val(),a.delivery_variant=$('input[name="delivery-variant__radio"]:checked').val(),a.delivery_service=$(".details-delivery__service>span").html(),a.delivery_price=$(".details-delivery__price>span").html(),a.delivery_days=$(".details-delivery__days>span").html(),a.payment=$('input[name="payment-method__radio"]:checked').val(),a.comment_user=$(".details-comment__textarea").val();let d=[],i='<strong><i class="fa-solid fa-triangle-exclamation"></i>&nbsp;&nbsp;Необходимо ввести:</strong>',s="",l="",t="",r=["name","surname","email","phone","captcha","legal"];if(void 0!=$("#user__login").html())for(let e in r)"legal"==r[e]?$("#user__legal").is(":checked")||d.push("legal"):""==$("#user__"+r[e]).val()?d.push(r[e]):a[r[e]]=$("#user__"+r[e]).val();if("курьером"==a.delivery_service.replace(/\s/g,"")?a.delivery_days="":(""==$("#user__address").val()?d.push("address"):$("#user__address").val()!=a.address&&d.push("delivery"),a.address=$("#user__address").val()),d.length>0){for(let e in d){$("#user__"+d[e]).addClass("is-invalid");let a=$("#user__"+d[e]+" ~ .feedback-short").html();"legal"==d[e]?l='<i class="fa-solid fa-triangle-exclamation"></i>&nbsp;&nbsp;Необходимо принять условия пользовательского соглашения':"delivery"==d[e]?t='<i class="fa-solid fa-triangle-exclamation"></i>&nbsp;&nbsp;Необходимо рассчитать доставку и выбрать транспортную компанию':""!=a&&(s+="<br>&mdash;&nbsp;&nbsp;"+a)}return""!=s&&(s=i+s),""!=l&&(""==s?s=l:s+="<br><br>"+l),""!=t&&(""==s?s=t:s+="<br><br>"+t),$(".toast").addClass("text-bg-danger"),$(".toast-body").html(s),toast.show(),void e.prop("disabled",!1)}loader(),$.ajax({type:"POST",url:"/order/checkout",data:a}).done(function(a){let d=JSON.parse(a);if($(".is-invalid").removeClass("is-invalid"),"ok"==d)$(".toast").removeClass("text-bg-danger"),$(".toast").addClass("text-bg-success"),$(".toast-body").html('<i class="fa-solid fa-check"></i>&nbsp;&nbsp;Заказ оформлен'),toast.show(),deleteCookie("orderId"),setTimeout(function(){location.href="/cabinet"},toastTimeout);else if("non-unique"==d)$("#user__email").addClass("is-invalid"),$(".toast").addClass("text-bg-danger"),$(".toast-body").html("Введите другую электронную почту"),toast.show(),e.prop("disabled",!1),loader(0);else{if(d.length>0){let e="";for(let a in d)e+="<br>&mdash;&nbsp;&nbsp;"+$("#user__"+d[a]+"~ .feedback-short").html(),$("#user__"+d[a]).addClass("is-invalid");e=i+e,$(".toast").addClass("text-bg-danger"),$(".toast-body").html(e),toast.show()}e.prop("disabled",!1),loader(0)}})}function updateOrder(){let e=new Object;e.token2=token2,e.address=$(".details-delivery__address>span").html(),e.delivery_type=$('input[name="delivery-type__radio"]:checked').val(),e.delivery_variant=$('input[name="delivery-variant__radio"]:checked').val(),e.delivery_price=$(".details-delivery__price>span").html(),e.delivery_days=$(".details-delivery__days>span").html(),e.payment=$('input[name="payment-method__radio"]:checked').val(),e.comment_user=$(".details-comment__textarea").val(),$.ajax({type:"POST",url:"/order/update",data:e}).done(function(e){let a=JSON.parse(e);"courier"==a.delivery_type?$(".details-payment__cod").addClass("d-none"):"mail"==a.delivery_type&&($(".details-payment__cod>span").html(a.cod),1==a.payment?$(".details-payment__cod").addClass("d-none"):2==a.payment&&$(".details-payment__cod").removeClass("d-none")),numberAnimation(".details-delivery__price>span",a.delivery_price),numberAnimation("#details__sum",a.total_sum)})}function resetDelivery(){let e=new Object;e.token2=token2,$.ajax({type:"POST",url:"/order/reset-delivery",data:e}).done(function(){$(".is-invalid").removeClass("is-invalid")})}function calculationDelivery(){let e=new Object;if(e.token2=token2,e.delivery_type=$('input[name="delivery-type__radio"]:checked').val(),e.delivery_variant=$('input[name="delivery-variant__radio"]:checked').val(),e.payment=$('input[name="payment-method__radio"]:checked').val(),e.comment_user=$(".details-comment__textarea").val(),e.postcode=vAddress.fields[10].name,"г"==vAddress.fields[0].type)e.address=vAddress.fields[0].name;else if(2==vAddress.fields[2].st)e.address=vAddress.fields[2].name;else{let a="",d=vAddress.fields[0].name.replace(/.\(.*\)/gm,"");if("Северная Осетия - Алания"==d)a="Республика Северная Осетия";else if("Саха /Якутия/"==d)a="Республика Саха (Якутия)";else{let e=["Адыгея","Дагестан","Ингушетия","Башкортостан","Татарстан","Алтай","Бурятия","Хакасия","Мордовия","Марий Эл","Калмыкия","Коми","Карелия","Крым","Тыва"];for(let i in e)d==e[i]&&(a="Республика "+e[i]);if(""==a){let e=" "+vAddress.fields[0].type;"обл"==vAddress.fields[0].type?e="область":"Респ"==vAddress.fields[0].type&&(e="Республика"),a=d+" "+e}}e.address=vAddress.fields[2].name+" ("+a+")"}void 0==e.address&&(e.address=""),$(".delivery-variant").addClass("d-none"),$(".delivery-spin").removeClass("d-none"),$.ajax({type:"POST",url:"/order/calculation-delivery",data:e}).done(function(e){let a=JSON.parse(e);if($(".delivery-spin").addClass("d-none"),$("#delivery-mail__calculation").prop("disabled",!0),"errorDeliveryPrice"==a)$("#user__address").addClass("is-invalid"),$(".details-delivery__address").addClass("d-none"),$(".details-delivery__price").addClass("d-none"),$(".details-delivery__days").addClass("d-none");else{$("#user__address").removeClass("is-invalid"),$(".delivery-variant").removeClass("d-none");let e=a.price,d=a.price+200,i=a.minDay+"-"+a.maxDay,s=wordByNumber(a.maxDay,["день","дня","дней"]);$(".delivery-variant__pvz-price").html(e+" ₽, "+i+" "+s),$("#delivery-variant__pvz").attr("data-days",i+" "+s),$("#delivery-variant__pvz").attr("data-price",e),$(".delivery-variant__courier-price").html(d+" ₽, "+i+" "+s),$("#delivery-variant__courier").attr("data-days",i+" "+s),$("#delivery-variant__courier").attr("data-price",d)}})}var vSuggestion,vAddress;$(function(){$(".details-comment__textarea").on("input",function(e){$(this).next("label").html("Комментарий к заказу "+$(this).val().length+"/250")}),$("#user__name").on("input",function(e){$(this).next("label").html("Имя "+$(this).val().length+"/150")}),$("#user__surname").on("input",function(e){$(this).next("label").html("Фамилия "+$(this).val().length+"/150")}),$("#user__login").click(function(){event.preventDefault(),setCookie("referrer","order"),location.href="/login"}),$("#user__settings").click(function(){event.preventDefault(),setCookie("referrer","order"),location.href="/settings"}),$("#delivery-mail__calculation").click(function(){setDeliveryCalculation()}),$("#order__checkout").click(function(){checkoutOrder()}),$("#details-bonus__checkbox").click(function(){setBonusOrder()}),$('input[name="delivery-type__radio"]').click(function(){setDeliveryType()}),$('input[name="delivery-courier__radio"]').click(function(){setDeliveryCourier()}),$('input[name="payment-method__radio"]').click(function(){setPaymentMethod()}),$('input[name="delivery-variant__radio"]').click(function(){setDeliveryVariant()})});